# AI 编码规则 - 对话管理和错误分析规范

> 📋 **本文档定义对话管理和错误分析的规则，所有 AI 助手必须遵守**

**版本**: v1.0.0
**生效日期**: 2026-01-25
**适用范围**: 所有对话和错误处理

---

## 🎯 核心原则

### 1. 对话追踪原则
每次对话都要完整记录，确保可追溯和可分析。

### 2. 错误学习原则
从错误中学习，持续优化编码规范，减少重复错误。

### 3. 数据驱动原则
基于 Token 使用和时间数据，优化对话效率。

---

## 📝 规则 1: 用户输入记录

### 记录要求

**必须记录的内容**：
- 用户输入内容（除了复制长串的 bug 或日志）
- 对话用时（从用户输入到 AI 响应完成）
- Token 使用量（输入 + 输出）

**不记录的情况**：
- 用户直接粘贴的完整错误日志（编译错误、堆栈跟踪等）
- 用户直接粘贴的长串调试输出
- 用户明确标注为"临时日志"或"调试信息"的内容
- AI 的响应内容（不记录）

### 记录格式

```markdown
## 对话 #{id}

**时间**: {timestamp}
**用时**: {duration}
**Token**: {input_tokens} + {output_tokens} = {total_tokens}
**用户输入**: {user_input}

---
```

### 记录位置

**主要记录文件**: `.claude/data/conversation_history.md`

**格式示例**:
```markdown
# 对话历史

**会话开始**: 2026-01-25

---

## 对话 #001
**时间**: 2026-01-25 14:30:00
**用时**: 2.5s
**Token**: 150 + 800 = 950
**用户输入**: "打tag作为V0.4.4,主要调整了宠物和设置两方面的功能"

---

## 对话 #002
**时间**: 2026-01-25 14:35:00
**用时**: 1.8s
**Token**: 200 + 1200 = 1400
**用户输入**: "每次打tag，不要有这么多细节"

---
```

---

## 📝 规则 2: 错误分析和规范优化

### 错误分类

当用户输入长串的 bug 或日志时，AI 必须：

#### 1. 判断错误类型

**常见/低级错误**（优先处理）：
- ❌ 拼写错误（变量名、函数名拼写错误）
- ❌ 大小写错误（类名、文件名大小写不匹配）
- ❌ 路径错误（导入路径、文件路径错误）
- ❌ 语法错误（缺少分号、括号不匹配）
- ❌ 类型错误（类型不匹配、类型转换错误）
- ❌ 空指针错误（未检查 null）
- ❌ 国际化错误（硬编码文本、缺少翻译键）
- ❌ 编码规范违反（命名不规范、格式错误）

**非常见/高级错误**：
- ⚠️ 架构设计问题
- ⚠️ 性能优化问题
- ⚠️ 跨平台兼容性问题
- ⚠️ 第三方库 Bug

#### 2. 判断是否因编码规范不严谨造成

**检查清单**：
- [ ] 错误是否在现有规范中有明确禁止？
- [ ] 错误是否违反了命名规范？
- [ ] 错误是否违反了国际化规范？
- [ ] 错误是否违反了文件组织规范？
- [ ] 错误是否可以通过更严格的规范避免？

**判断标准**：
```dart
// ✅ 规范不严谨造成的错误示例
Text('保存路径')  // 违反国际化规范 → 应该加强国际化规范
var name = 'test'  // 违反代码风格规范 → 应该禁止使用 var
final _data = json.decode(response)  // 未检查类型 → 应该添加类型检查规范

// ❌ 非规范问题示例
// 第三方库的 bug → 不需要修改规范
// 架构设计问题 → 可能需要设计规范，但不是编码规范问题
```

#### 3. 处理方式

**方式 1: 使用错题集知识库**

创建 `.claude/data/error_patterns.md`：

```markdown
# 错误模式知识库

## 国际化错误

### 模式 #001: 硬编码用户可见文本
**错误示例**:
```dart
Text('保存路径')
```

**错误原因**: 违反国际化最高优先级原则

**解决方案**: 使用 `l10n.xxx` 访问翻译
```dart
Text(l10n.screenshot_savePath)
```

**预防措施**:
- 在代码审查中强制检查所有硬编码文本
- 添加 linter 规则检测硬编码字符串
- 在编码规范中强调国际化优先级

**相关规范**: `.claude/rules/FILE_ORGANIZATION_RULES.md` → 国际化约定

---

## 类型错误

### 模式 #002: 使用 dynamic 类型
**错误示例**:
```dart
Map<String, dynamic> data = json.decode(response);
```

**错误原因**: 违反禁止使用 dynamic 的规范

**解决方案**: 明确指定类型或使用类型安全的方式
```dart
final data = json.decode(response) as Map<String, String>;
```

**预防措施**:
- 在 analysis_options.yaml 中禁用 dynamic
- 代码审查时重点检查类型定义

**相关规范**: `.claude/rules/CODE_STYLE_RULES.md` → 禁止的写法
```

**方式 2: 优化编码规范**

如果错误是**因为规范不严谨造成的**，必须：

1. **识别规范漏洞**
   - 哪个规范文件需要更新？
   - 哪条规则不够明确？
   - 是否需要添加新的规则？

2. **更新规范文件**
   - 添加更严格的规则
   - 添加示例说明
   - 添加预防措施

3. **记录优化历史**
   - 在规范文件中记录更新原因
   - 关联到具体的错误模式
   - 标注更新时间和版本

**示例**：
```markdown
## 更新历史

### v1.1.0 (2026-01-25)
- **新增**: 禁止在 Widget 中硬编码文本（违反国际化规范）
- **原因**: 错误模式 #001 - 多次出现硬编码用户可见文本
- **影响**: 所有 UI 代码必须使用 l10n
```

### 错误分析流程

```
用户输入长串 bug/日志
    ↓
判断：是否为常见/低级错误？
    ├─ 是 → 继续
    └─ 否 → 直接处理（不进入规范优化流程）
    ↓
判断：是否因规范不严谨造成？
    ├─ 是 → 进入规范优化流程
    │      1. 记录到错题集知识库
    │      2. 分析规范漏洞
    │      3. 更新相关规范文件
    │      4. 添加预防措施
    └─ 否 → 仅记录到错题集（不修改规范）
    ↓
提供解决方案
    ↓
在响应中说明：
- 错误类型
- 是否规范问题
- 是否更新了规范
- 如何避免重复错误
```

### 响应模板

当处理错误时，使用以下模板：

```markdown
## 🔍 错误分析

### 错误类型
{常见/低级错误} - {具体类型}

### 是否规范问题
{是/否}

### 根本原因
{详细分析}

### 解决方案
{具体代码或操作}

### 规范优化
{如果是规范问题}
- ✅ 已更新 `.claude/rules/{RULE_FILE}.md`
- ✅ 已添加到错题集知识库
- 📋 规范变更：{具体变更内容}

### 预防措施
{如何避免重复错误}
```

---

## 📝 规则 3: 对话 ID 管理

### ID 系统设计

**ID 格式**: `#{number}`（例如 #001, #002, #003）

**ID 分配规则**:
- 新上下文开始时：重置为 #001
- 每轮对话结束：自增 +1
- ID 必须在规则 1 的记录中包含

### ID 使用位置

1. **对话记录中**（规则 1）
   ```markdown
   ## 对话 #003
   **用户输入**: "..."
   ```

2. **每轮对话结束时**
   - 仅输出 ID 号
   - 不输出其他统计信息

3. **错误模式知识库中**（规则 2）
   ```markdown
   ### 模式 #001
   **发现于对话**: #003
   ```

### ID 维护方式

**从对话上下文中维护**：
- AI 在对话开始时从上下文中获取当前 ID（如果有的话）
- 每轮对话结束时在回复中告知 ID
- 新上下文开始时重置为 #001

### ID 重置条件

**何时重置为 #001**：
- ✅ 新的上下文窗口开始（context 被清空）
- ✅ 新的一天开始（可选）
- ✅ 用户明确要求重置

**何时不重置**：
- ❌ 仅仅因为总结对话
- ❌ 仅仅因为创建了新的文件
- ❌ 用户未要求的任何情况

---

## ✅ 执行清单

### 每轮对话开始时
- [ ] 从上下文中获取当前对话 ID
- [ ] 读取 `.claude/data/error_patterns.md`，了解已知错误模式（可选）

### 每轮对话进行中
- [ ] 记录用户输入（如果不是长串 bug/日志）
- [ ] 如果收到长串 bug/日志：
  - [ ] 判断错误类型
  - [ ] 判断是否规范问题
  - [ ] 记录到错题集（如需要）
  - [ ] 更新规范（如需要）

### 每轮对话结束时
- [ ] 更新对话历史（添加新对话记录）
- [ ] 告知用户当前对话 ID
- [ ] 提交所有更改到 git（如有必要）

---

## 📚 相关文件

### 必需的文件结构

```
.claude/
├── data/
│   ├── conversation_history.md      # 对话历史（规则 1）
│   └── error_patterns.md            # 错误模式知识库（规则 2）
└── rules/
    ├── CONVERSATION_MANAGEMENT_RULES.md  # 本文件
    └── {OTHER_RULES}.md
```

### 文件创建时机

**首次使用时**：自动创建所有必需文件

**每次对话时**：自动更新对应文件

---

## 🔧 实现细节

### 对话记录格式（conversation_history.md）

```markdown
# 对话历史

**会话开始**: 2026-01-25

---

## 对话 #001
**时间**: 2026-01-25 14:30:00
**用时**: 2.5s
**Token**: 150 + 800 = 950
**用户输入**: "打tag作为V0.4.4"

---

## 对话 #002
**时间**: 2026-01-25 14:35:00
**用时**: 1.8s
**Token**: 200 + 1200 = 1400
**用户输入**: "每次打tag，不要有这么多细节"

---
```

### 错误模式格式（error_patterns.md）

```markdown
# 错误模式知识库

**最后更新**: 2026-01-25
**总错误模式**: 15

---

## 国际化错误

### 模式 #001: 硬编码用户可见文本
**发现于对话**: #003
**发现时间**: 2026-01-25 15:00:00
**错误级别**: 🔴 严重（违反最高优先级规范）

**错误示例**:
\`\`\`dart
Text('保存路径')
\`\`\`

**错误原因**: 违反国际化最高优先级原则

**解决方案**:
\`\`\`dart
Text(l10n.screenshot_savePath)
\`\`\`

**预防措施**:
- 在代码审查中强制检查
- 添加 linter 规则

**相关规范**: `FILE_ORGANIZATION_RULES.md` → 国际化约定

**状态**: ✅ 已记录

---

## 类型错误

### 模式 #002: 使用 dynamic 类型
**发现于对话**: #005
**发现时间**: 2026-01-25 16:00:00
**错误级别**: 🟡 中等（违反代码风格规范）

...
```

---

## 🎯 快速参考

| 场景 | 操作 | 输出 |
|------|------|------|
| **用户输入** | 记录到 conversation_history.md | 对话 #{id} |
| **收到 bug** | 分析并记录到 error_patterns.md | 错误模式 #{id} |
| **规范问题** | 更新相关规则文件 | 规范 v{x.y.z} |
| **对话结束** | 报告 ID、用时、Token | 统计信息 |

---

## 📝 规则更新历史

### v1.1.0 (2026-01-25)
- **简化规则**: 移除 Token 和用时记录
- **简化 ID 管理**: 从对话上下文中维护，不从文件读取
- **简化输出**: 对话结束时只输出 ID

### v1.0.0 (2026-01-25)
- **初始版本**: 创建对话管理和错误分析规范
- **核心功能**:
  - 对话 ID 系统
  - 用户输入记录
  - 错误模式分析
  - 规范优化流程

---

**版本**: v1.1.0
**最后更新**: 2026-01-25
**维护者**: Flutter Plugin Platform 团队

---

💡 **提示**: 这些规则确保每次对话都有价值，从错误中持续学习！
